#!/usr/bin/env node

var
estatico = require('../index'),
program = require('commander'),
chalk = require('chalk'),
log = require('gulp-util').log,
watch = require('chokidar').watch,
path = require('path')


program.version(require('../package.json').version)


/**
 * Shortcut to create an App, and log proccess
 * @return {App} 
 */
function newApp(env){

	var app = new estatico.App(process.cwd(), env)

	log('Starting app in ' + process.cwd())

	return app
}

/**
 * Build app + log proccess
 * @param  {App} app application to build
 * @return {Promise}     promise taht will be resolved when site is built
 */
function build(app){

	log('Building site...')

	var promise = app.build()

	promise.then(function(site, theme){
		log('Site successfully built to ' + chalk.green(site.destinationDir))
	})

	return promise
}


function reload(app, event){
	return function(file){

		var 
		pattern = path.join(app.getBaseDir(), 'content/'),
		rel = path.relative(pattern, file)

		console.log('\n')
		log('File [' + chalk.cyan(rel) + '] ' + event +'.' )
		
		build(app)
	}
}



program
	.command('serve [env]')
	.description('Serves application using current dir')
	.action(function(env, opts){

		var app = newApp(env)

		build(app).then(function(site, theme){
			app.serve(site)

			log('Site running at ' + chalk.green(site.url))
			log('Press Ctrl + C to stop')


			// Watch filechanges
			var 
			pattern = path.join(app.getBaseDir(), 'content/'),
			opts = {ignoreInitial:  true}

			log('Watching ' + chalk.cyan(pattern) + '...')

			watch(pattern, opts).on('change', reload(app, 'updated'))
			watch(pattern, opts).on('add', reload(app, 'added'))
			watch(pattern, opts).on('unlink', reload(app, 'deleted'))
		})




	})


program
	.command('build [env]')
	.description('Build application')
	.action(function(env, opts){

		var app = newApp(env)

		build(app)
	})



/**
 * Parse.
 */
program.parse(process.argv)



// Shows help by default
if (!process.argv.slice(2).length) {
  program.outputHelp();
}

