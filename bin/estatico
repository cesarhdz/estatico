#!/usr/bin/env node

var
program = require('commander'),
chalk = require('chalk'),
log = require('gulp-util').log,

estatico = require('../index'),
version = require('../package.json').version


/**
 * Shortcut to create an App, and log proccess
 * @return {App} 
 */
function newApp(env){

	var app = new estatico.App({env:env})

	log('Starting app in ' + app.dir)

	return app
}

/**
 * Build app + log proccess
 * @param  {App} app application to build
 * @return {Promise}     promise taht will be resolved when site is built
 */
function build(app){

	log('Building site...')

	var 
	site = app.bootstrap(),
	promise = app.build(site)

	promise.then(function(){
		log('Site successfully built to ' + chalk.green(site.app.destinationDir))
	})

	return promise
}

/**
 * Serve
 */
program
	.command('serve [env]')
	.description('Serves application using current dir')
	.action(function(env, opts){

		var app = newApp(env)

		build(app).then(function(site, theme){
			app.server.start(site)

			log('Site running at ' + chalk.green(site.url))
			log('Press Ctrl + C to stop')

			app.server.watch(app, site)
		})
	
	})

/**
 * build
 */
program
	.command('build [env]')
	.description('Build application')

	.action(function(env, opts){

		//@TODO Add configurable options
		var app = newApp(env)

		build(app)
	})



/**
 * bootstrap
 */
program.parse(process.argv)



// Shows help by default
if (!process.argv.slice(2).length) {
  program.outputHelp();
}

